# JS Holder SDK

## Disclaimer

The artefacts in this repo are offered without warranty or liability, in accordance with the [MIT licence.](https://github.com/ConsumerDataStandardsAustralia/java-artefacts/blob/master/LICENSE)

[The Data Standards Body](https://www.csiro.au/en/News/News-releases/2018/Data61-appointed-to-Data-Standards-Body-role)
(DSB) develops these artefacts in the course of its work, in order to perform quality assurance on the Australian Consumer Data Right Standards (Data Standards).

The DSB makes this repo, and its artefacts, public [on a non-commercial basis](https://github.com/ConsumerDataStandardsAustralia/java-artefacts/blob/master/LICENSE)
in the interest of supporting the participants in the CDR eco-system.

The resources of the DSB are primarily directed towards assisting the [Data Standards Chair](https://consumerdatastandards.gov.au/about/)
for [developing the Data Standards](https://github.com/ConsumerDataStandardsAustralia/standards).

Consequently, the development work provided on the artefacts in this repo is on a best-effort basis,
and the DSB acknowledges the use of these tools alone is not sufficient for, nor should they be relied upon
with respect to [accreditation](https://www.accc.gov.au/focus-areas/consumer-data-right-cdr-0/cdr-draft-accreditation-guidelines),
conformance, or compliance purposes.

## The Problem

In line with the Australian Consumer Data Rights legislation the Data Standards Body defines a number of technical requirements on API endpoints for various industry sector. In particular the standard defines error payloads to be a specific format, containing specific error codes, etc.
Because these error handling requirements across a large number of endpoints, coding these can be repetitive and therefore error prone.

## The Solution

This packages is a boilerplate implementation of these common requirements and it can be used in any NodeJS / ExpressJS application as middleware.

The key functions exported by this package are `cdrHeaderValidator, cdrResourceValidator, cdrScopeValidator and cdrEndpointValidator`.

The available middleware functions are intended for use in the application layer. 

### cdrHeaderValidator

This middleware function will handle some basic header checks and construct a CDR compliant *ErrorList* object where this required and return an appropriate Http status code.

| Scenario      | Description |
| ----------- | ----------- |
| No x-v header is provided in the request    | - Http status code 400 </br> - An *ErrorList* is returned with Header/Missing.    |
| Invalid x-v header is provided with the request, eg alpha character   | - Http status code 400 </br> - An *ErrorList* is returned with Header/Invalid. |
| Invalid x-min-v header is provided with the request |  Http status code 400 </br> - An *ErrorList* is returned with Header/Invalid. |
| A requested version is not supported | - Http status code 406 </br> - An *ErrorList* is returned with Header/UnsupportedVersion. |
| No x-fapi-interaction-id  in the request    | An x-fapi-interaction-id header is set in the response header    |
| Request has x-fapi-interaction-id header    | The x-fapi-interaction-id from the request is returned with the response header   |
| Invalid x-fapi-interaction-id header is provided with the request  | - Http status code 400 </br> - An *ErrorList* is returned with Header/Invalid. |

![Design](/images/MiddleWareDesign-cdrHeaderValidator.jpg "Header Validator")

### cdrEndpointValidator

This middleware function will examine the requst url and determine if it is a CDR endpoint. It construct a CDR compliant *ErrorList* object where this required and return an appropriate Http status code.

| Scenario      | Description |
| ----------- | ----------- |
| Endpoint not implemented | - Http status code 404 </br> - An *ErrorList* is returned with Resource/NotImplemented. |
| Endpoint not is not a CDR endpoint | - Http status code 404 </br> - An *ErrorList* is returned with Resource/NotFound. |

![Design](/images/MiddleWareDesign-cdrEndpointValidator.jpg "Endpoint Validator")

### cdrScopeValidator

This middleware function will perform a scope validation. It will check the user assigned scope against the scope required for the API endpoint. The function will construct a CDR compliant *ErrorList* object where this required and return the appropriate Http status code.

*Note that this functionality requires access to the scopes contained from access token generated by the IdAM  (Identity and Access Management System). To achive this an implementation of **IUserService** is required to be passed in by the consumer of this middleware.*

*Refer to the example project in [js-holder-sdk-demo](https://github.com/ConsumerDataStandardsAustralia/js-holder-sdk-demo) project*

| Scenario      | Description |
| ----------- | ----------- |
| Invalid scope in access token   | - Http status code 403 </br> - An *ErrorList* is returned with Authorisation/InvalidScope |

![Design](/images/MiddleWareDesign-cdrScopeValidator.jpg "Scope Validator")

### cdrResourceValidator

This middleware function will validate resource specific identifiers (eg accountId) and ensure that consent to access these resources has been given. This function is only relevant to API calls where a resource identifier forms part of the request url (eg /banking/accounts/{accountId})


*Note that this functionality requires knowledge of the consented accounts. This information can be obtained  from access token generated by the IdAM  (Identity and Access Management System). To achive this an implementation of **IUserService** is required to be passed in by the consumer of this middleware.*

| Scenario      | Description |
| ----------- | ----------- |
| Access to the resource url has not been consented to | Http status code 404 </br>  |

![Design](/images/MiddleWareDesign-cdrResourceValidator.jpg "Resource Validator")

### Example Request Pipeline

The diagram illustrates one possible request pipeline and how the middleare functions can be used in a data holder implementation.

Other implementations using a different order, of only some of of the exposed functions are entirely possible.

![Design](/images/MiddleWareDesign-ExamplePipeline.jpg "Example Pipeline")

### How to use
Install the library with npm or yarn
`npm i @cds-au/holder-sdk`

Import the library
```javascript
import { cdrHeaderValidator }  from '@cds-au/holder-sdk';
```
then inject in http pipeline where this is appropriate
```javascript
app.use(cdrHeaderValidator(dsbOptions));
```


### Configuration Object

The middleware functions `cdrHeaderValidator` and ` cdrEndpointValidator`   will expect a configuration object (CdrConfig). This object should define each endpoint implemented by the application.
Each endpoint must be defined by the request type (GET/POST/DELETE) and the path as defined in the published [standard](https://consumerdatastandardsaustralia.github.io/standards/#introduction)

```javascript
const implementedEndpoints = [
    {
        "requestType": 
        "GET",
        "requestPath": "/banking/payments/scheduled",
        "minSupportedVersion": 1,
        "maxSupportedVersion": 1
    },
    {
        "requestType": "GET",
        "requestPath": "/banking/accounts/{accountId}/balance",
        "minSupportedVersion": 1,
        "maxSupportedVersion": 1
    },
…etc


const dsbOptions: CdrConfig = {
    endpoints: implementedEndpoints
}

app.use(cdrHeaderValidator(dsbOptions))

```

### The IUserInterface

The cdrScopeValidator and cdrResourceValidator require some information about the currently logged in user, such as available scopes and consented accounts. The consumer of the these functions (eg the data holder implementation) must pass in an implementation of the IUserInterface which will then be called by the cdrScopeValidator and cdrResourceValidator.

```javascript
export interface IUserService {   
    getUser(): CdrUser | undefined;
}
```

The middleware makes no assumptions on how this user specific data is being retrieved. 
Depending on the system being developed, the data holder may get this information from an authorisation server, or it may be hard coded to a specific user (eg for test systems).

Example implementation:
```javascript
const userService: IUserService = {
    getUser(): CdrUser {
        let usr : CdrUser = {
            accountsEnergy:['12345'],
            accountsBanking:['234324'],
            scopes_supported: [
                'energy:accounts.basic:read',
                'bank:payees:read',
                'energy:accounts.detail:read',
                'energy:electricity.servicepoints.basic:read',
                'energy:electricity.servicepoints.detail:read',
                'bank:accounts.basic:read']
        }
        return usr;
    }
}
```

then inject in http pipeline where this is appropriate
```javascript
app.use(cdrScopeValidator(userService));
```

### Demo Project

*Note: The demo project with this library was tested with NodeJS v18.7.0*

The [js-holder-sdk-demo](https://github.com/ConsumerDataStandardsAustralia/js-holder-sdk-demo) project provides a basic implementation illustrating how the middleware can be used in a NodeJS/ ExpressJS  application
